@startuml
title Correct Serialization: TX Task vs CMD Task (With uart0_dma_tx_mutex)

participant "TX Task\n(Priority 6)" as TX
participant "uart0_dma_tx_mutex" as MTX #orange
participant "DMA Channel 2\n(UART0_TX)" as DMA
participant "CMD Task\n(Priority 8)" as CMD
participant "UART0 TX FIFO" as UART0

== With Mutex Protection - CORRECT SERIALIZATION ==

note over TX, CMD #lightgreen
**Scenario**: Same situation - both tasks need UART0 TX
**Solution**: uart0_dma_tx_mutex serializes DMA access
end note

TX -> TX: Dequeue forward descriptor
activate TX #lightgreen
note right: UART0_Buffer[slot#5]\nLength: 128 bytes

TX -> MTX: tx_mutex_get(TX_WAIT_FOREVER)
activate MTX #orange
note right of MTX: **ACQUIRES LOCK**\nOwner: TX Task (P6)\nPriority inheritance enabled

TX -> DMA: Write SRC_ADDR = 0x20008000
note right of DMA: **Protected write 1/4**\nSource: UART0_Buffer[slot#5]

TX -> DMA: Write DEST_ADDR = 0x40001000
note right of DMA: **Protected write 2/4**\nDest: UART0 TX FIFO

note over CMD: CMD processing complete!\nResponse ready in CMD_Pool
CMD -> CMD: Dequeue response descriptor
activate CMD #orange
note left: CMD_Pool[slot#0]\nLength: 4096 bytes

CMD -> TX: !! PREEMPTS TX Task !!

CMD -> MTX: tx_mutex_get(TX_WAIT_FOREVER)
note right of MTX #lightyellow: **BLOCKS** waiting for mutex\n(TX Task still holds lock)\nPriority inheritance: P6 → P8

note over TX: TX Task RESUMES\n(mutex owner runs at P8 now)
activate TX #lightblue

TX -> DMA: Write COUNT = 128
note right of DMA: **Protected write 3/4**\nLength: 128 bytes

TX -> DMA: Write CTRL = START
note right of DMA: **Protected write 4/4**\n**Atomic sequence complete!**

DMA -> UART0: Transfer 128 bytes from UART0_Buffer[slot#5]
activate UART0 #lightgreen
note right of UART0: **CORRECT DATA**:\n✓ Correct source buffer\n✓ Correct transfer length\n✓ Packet forwarded successfully

TX -> MTX: tx_mutex_put()
deactivate MTX
deactivate TX
note right of MTX: **RELEASES LOCK**\nDMA running independently

CMD -> MTX: tx_mutex_get() RETURNS
activate MTX #orange
note right of MTX: **ACQUIRES LOCK**\nOwner: CMD Task (P8)

activate CMD #lightgreen

CMD -> DMA: Wait for DMA completion
note right of DMA: DMA channel must be IDLE\nbefore reconfiguration

deactivate UART0
note over DMA, UART0: DMA completion interrupt\n(~1.1ms @960kbps, 128B)

CMD -> DMA: Write SRC_ADDR = 0x20010000
note right of DMA: **Protected write 1/4**\nSource: CMD_Pool[slot#0]

CMD -> DMA: Write DEST_ADDR = 0x40001000
note right of DMA: **Protected write 2/4**\nDest: UART0 TX FIFO

CMD -> DMA: Write COUNT = 4096
note right of DMA: **Protected write 3/4**\nLength: 4096 bytes

CMD -> DMA: Write CTRL = START
note right of DMA: **Protected write 4/4**\n**Atomic sequence complete!**

DMA -> UART0: Transfer 4096 bytes from CMD_Pool[slot#0]
activate UART0 #lightgreen
note right of UART0: **CORRECT DATA**:\n✓ Correct source buffer\n✓ Correct transfer length\n✓ CMD response transmitted

CMD -> MTX: tx_mutex_put()
deactivate MTX
deactivate CMD
deactivate UART0

note over TX, UART0 #lightgreen
**SUCCESS - BOTH PACKETS TRANSMITTED CORRECTLY**:

✅ **Sequential Execution**: TX Task completes DMA config before CMD Task starts
✅ **No Register Corruption**: Mutex protects 4-register write sequence
✅ **Correct Buffers**: Each task transmits from intended buffer
✅ **Correct Lengths**: Each transfer uses correct byte count
✅ **Priority Inheritance**: TX Task elevated to P8 while holding mutex (prevents inversion)

**Performance Impact**:
- Mutex overhead: ~1μs per acquire/release
- Serialization delay: Negligible (CMD Task waits ~1.1ms for DMA completion anyway)
- Total overhead: <0.1% (1μs / 1.1ms transmission time)

**ThreadX Mutex Features Used**:
1. **Priority Inheritance**: Prevents unbounded priority inversion
2. **Ownership Tracking**: Only owner can release mutex
3. **Blocking**: Higher priority task blocks on mutex (not busy-wait)
4. **FIFO Queuing**: Tasks queued in priority order when waiting

**Hardware Protection**: uart0_dma_tx_mutex ensures DMA-230 Channel 2
register set is accessed atomically by ONE task at a time.
end note

@enduml
